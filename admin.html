<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/Sweet_Delight_icon.jpg" type="image/jpeg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" 
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Sweet Delights Â· Admin Console</title>
    <style>
        :root {
            --coffee: #3c2005;
            --coffee-deep: #2b1400;
            --cream: #f6efe4;
            --amber: #ffb300;
            --amber-soft: rgba(255, 179, 0, 0.16);
            --peach: #f3a261;
            --card-bg: rgba(255, 255, 255, 0.94);
            --card-border: rgba(60, 32, 5, 0.08);
            --shadow-lg: 0 28px 60px rgba(60, 32, 5, 0.12);
            --muted: rgba(60, 32, 5, 0.56);
            --success: #3c8c49;
            --warning: #d97706;
            --info: #2563eb;
            --danger: #b91c1c;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Georgia', serif;
            color: var(--coffee);
            background: radial-gradient(circle at top left, rgba(255, 236, 208, 0.74), rgba(235, 229, 217, 0.95));
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        img {
            max-width: 100%;
            display: block;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        .admin-header {
            background: linear-gradient(120deg, rgba(60, 32, 5, 0.96), rgba(199, 111, 0, 0.92));
            color: #fff;
            padding: 20px clamp(20px, 5vw, 48px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 20px 40px rgba(44, 24, 2, 0.2);
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 16px;
            font-weight: 700;
            letter-spacing: 0.04em;
        }

        .brand img {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.18);
            background: rgba(255, 255, 255, 0.92);
            padding: 6px;
        }

        .brand span {
            font-size: clamp(1.4rem, 2.6vw, 1.8rem);
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .brand span small {
            font-size: 0.7em;
            font-weight: 500;
            opacity: 0.8;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .button {
            border: none;
            border-radius: 999px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            color: var(--coffee);
            background: #fff;
            box-shadow: 0 8px 16px rgba(60, 32, 5, 0.16);
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 28px rgba(60, 32, 5, 0.18);
        }

        .button-secondary {
            background: rgba(255, 255, 255, 0.32);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: none;
        }

        .button-secondary:hover {
            background: rgba(255, 255, 255, 0.48);
            color: var(--coffee);
        }

        .button-danger {
            background: rgba(185, 28, 28, 0.9);
            color: #fff;
            box-shadow: 0 12px 24px rgba(185, 28, 28, 0.2);
        }

        .button-danger:hover {
            background: rgba(185, 28, 28, 1);
        }

        .admin-main {
            width: min(1200px, 92vw);
            margin: clamp(32px, 5vw, 56px) auto;
            display: flex;
            flex-direction: column;
            gap: clamp(28px, 4vw, 40px);
        }

        .metric-grid {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
        }

        .metric-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--card-border);
            position: relative;
            overflow: hidden;
            isolation: isolate;
        }

        .metric-card::after {
            content: "";
            position: absolute;
            inset: 12px 12px auto auto;
            width: 68px;
            height: 68px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 179, 0, 0.3), transparent 70%);
            z-index: -1;
        }

        .metric-label {
            font-size: 0.86rem;
            text-transform: uppercase;
            letter-spacing: 0.18em;
            color: var(--muted);
            margin-bottom: 6px;
            display: block;
        }

        .metric-value {
            font-size: clamp(1.8rem, 4vw, 2.4rem);
            font-weight: 700;
            color: var(--coffee);
        }

        .metric-footnote {
            font-size: 0.85rem;
            color: rgba(60, 32, 5, 0.6);
            margin-top: 6px;
            display: block;
        }

        .control-panel {
            background: var(--card-bg);
            border-radius: 24px;
            padding: clamp(20px, 4vw, 28px);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--card-border);
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            align-items: end;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .field-label {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--coffee);
        }

        input[type="search"],
        select {
            border-radius: 16px;
            border: 1px solid rgba(60, 32, 5, 0.2);
            padding: 12px 16px;
            font-family: inherit;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.9);
            transition: border 0.3s ease, box-shadow 0.3s ease;
        }

        input[type="search"]:focus,
        select:focus {
            outline: none;
            border-color: var(--amber);
            box-shadow: 0 0 0 4px rgba(255, 179, 0, 0.15);
        }

        .chip-group {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .chip {
            border: 1px solid rgba(60, 32, 5, 0.18);
            border-radius: 999px;
            padding: 7px 16px;
            font-size: 0.9rem;
            background: rgba(255, 255, 255, 0.74);
            color: var(--coffee);
            cursor: pointer;
            transition: background 0.25s ease, color 0.25s ease, transform 0.2s ease;
        }

        .chip:hover {
            transform: translateY(-1px);
        }

        .chip--active {
            background: var(--amber);
            color: var(--coffee);
            border-color: transparent;
            box-shadow: 0 12px 24px rgba(255, 179, 0, 0.32);
        }

        .toggle-field {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-field input {
            width: 48px;
            height: 26px;
            appearance: none;
            background: rgba(60, 32, 5, 0.25);
            border-radius: 999px;
            position: relative;
            cursor: pointer;
            transition: background 0.25s ease;
        }

        .toggle-field input::after {
            content: "";
            position: absolute;
            top: 3px;
            left: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            transition: transform 0.25s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.18);
        }

        .toggle-field input:checked {
            background: rgba(60, 140, 73, 0.9);
        }

        .toggle-field input:checked::after {
            transform: translateX(20px);
        }

        .toggle-field span {
            font-size: 0.95rem;
            color: var(--coffee);
            font-weight: 600;
        }

        .orders-section {
            background: var(--card-bg);
            border-radius: 24px;
            padding: clamp(24px, 4vw, 32px);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--card-border);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .orders-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .orders-header h2 {
            margin: 0;
            font-size: clamp(1.5rem, 3vw, 1.9rem);
        }

        .order-count {
            font-weight: 600;
            padding: 6px 16px;
            border-radius: 999px;
            background: var(--amber-soft);
            color: var(--coffee);
        }

        .help-text {
            color: var(--muted);
            font-size: 0.92rem;
            margin: 4px 0 0;
        }

        .order-list {
            display: grid;
            gap: 20px;
        }

        .order-list--empty {
            align-items: center;
            justify-items: center;
            text-align: center;
            min-height: 220px;
            display: grid;
        }

        .empty-state i {
            font-size: 2.4rem;
            color: var(--amber);
            margin-bottom: 12px;
        }

        .empty-state p {
            margin: 4px 0;
        }

        .empty-state .hint {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .order-card {
            border-radius: 20px;
            border: 1px solid rgba(60, 32, 5, 0.08);
            background: rgba(255, 255, 255, 0.85);
            padding: 22px 24px;
            box-shadow: 0 20px 40px rgba(44, 24, 2, 0.08);
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
            overflow: hidden;
        }

        .order-card::before {
            content: "";
            position: absolute;
            inset: 0;
            opacity: 0.08;
            background: linear-gradient(135deg, rgba(255, 179, 0, 0.5), transparent);
            pointer-events: none;
        }

        .order-card__header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
        }

        .order-card__header h3 {
            margin: 0;
            font-size: 1.35rem;
        }

        .order-meta {
            margin: 4px 0 0;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .order-status {
            display: grid;
            gap: 6px;
            min-width: 200px;
        }

        .order-status-select {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid rgba(60, 32, 5, 0.18);
            background: rgba(255, 255, 255, 0.96);
            font-size: 0.95rem;
        }

        .order-status-select:focus {
            outline: none;
            border-color: var(--amber);
            box-shadow: 0 0 0 3px rgba(255, 179, 0, 0.24);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            width: fit-content;
        }

        .status-pill[data-status="Pending"] {
            background: rgba(217, 71, 15, 0.16);
            color: #b45309;
        }

        .status-pill[data-status="Preparing"] {
            background: rgba(37, 99, 235, 0.14);
            color: var(--info);
        }

        .status-pill[data-status="Ready"] {
            background: rgba(16, 185, 129, 0.18);
            color: #047857;
        }

        .status-pill[data-status="Out for Delivery"] {
            background: rgba(14, 116, 144, 0.16);
            color: #0f766e;
        }

        .status-pill[data-status="Delivered"] {
            background: rgba(60, 140, 73, 0.18);
            color: var(--success);
        }

        .item-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: inset 0 0 0 1px rgba(60, 32, 5, 0.06);
        }

        .item-table th,
        .item-table td {
            padding: 12px 14px;
            text-align: left;
        }

        .item-table thead {
            background: rgba(255, 179, 0, 0.22);
            color: var(--coffee);
            font-weight: 700;
        }

        .item-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.7);
        }

        .order-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 14px;
            margin: 12px 0 0;
        }

        .order-details dt {
            font-weight: 600;
            color: var(--coffee);
        }

        .order-details dd {
            margin: 4px 0 0;
            color: var(--muted);
            word-break: break-word;
        }

        .order-card__footer {
            display: grid;
            gap: 10px;
        }

        .note-label {
            font-weight: 600;
            color: var(--coffee);
            font-size: 0.9rem;
        }

        .order-note-input {
            border-radius: 14px;
            border: 1px solid rgba(60, 32, 5, 0.18);
            padding: 12px 14px;
            min-height: 70px;
            resize: vertical;
            font-family: inherit;
            font-size: 0.92rem;
            background: rgba(255, 255, 255, 0.9);
            transition: border 0.3s ease, box-shadow 0.3s ease;
        }

        .order-note-input:focus {
            outline: none;
            border-color: var(--amber);
            box-shadow: 0 0 0 3px rgba(255, 179, 0, 0.18);
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .ghost-button {
            border: 1px dashed rgba(60, 32, 5, 0.26);
            background: transparent;
            border-radius: 12px;
            padding: 8px 14px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--coffee);
            transition: border 0.2s ease, background 0.2s ease;
        }

        .ghost-button:hover {
            border-style: solid;
            background: rgba(255, 179, 0, 0.18);
        }

        .ghost-button--success {
            border-color: rgba(60, 140, 73, 0.6);
            color: var(--success);
            background: rgba(60, 140, 73, 0.12);
        }

        .status-label {
            font-size: 0.78rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--muted);
        }

        .admin-footer {
            margin-top: auto;
            padding: 24px 16px 32px;
            text-align: center;
            font-size: 0.9rem;
            color: rgba(60, 32, 5, 0.6);
        }

        @media (max-width: 768px) {
            .admin-header {
                padding: 18px 20px;
            }

            .brand {
                width: 100%;
                justify-content: center;
            }

            .header-actions {
                justify-content: center;
            }

            .order-card {
                padding: 20px;
            }

            .order-status {
                width: 100%;
            }

            .orders-header {
                align-items: flex-start;
            }
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: radial-gradient(circle at top left, rgba(63, 39, 14, 0.92), rgba(30, 20, 14, 0.9));
                color: #f9f5ee;
            }

            .admin-header {
                background: linear-gradient(140deg, rgba(42, 22, 4, 0.95), rgba(184, 117, 23, 0.85));
            }

            .metric-card,
            .control-panel,
            .orders-section,
            .order-card {
                background: rgba(28, 17, 8, 0.88);
                border-color: rgba(255, 255, 255, 0.08);
                box-shadow: 0 24px 44px rgba(0, 0, 0, 0.35);
            }

            .metric-value,
            .field-label,
            .orders-header h2,
            .order-card__header h3 {
                color: #fdf3d8;
            }

            input[type="search"],
            select,
            .order-status-select,
            .order-note-input {
                background: rgba(21, 13, 6, 0.72);
                color: #fdf3d8;
                border-color: rgba(255, 255, 255, 0.08);
            }

            .order-details dd {
                color: rgba(253, 243, 216, 0.72);
            }

            .ghost-button {
                color: #fdf3d8;
                border-color: rgba(253, 243, 216, 0.3);
            }

            .button {
                color: #2a1502;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <a class="brand" href="bakery.html">
            <img src="assets/Sweet_Delight_icon.png" alt="Sweet Delights logo">
            <span>
                Sweet Delights
                <small>Order Console</small>
            </span>
        </a>
        <div class="header-actions">
            <a class="button-secondary button" href="bakery.html" target="_blank" rel="noopener">
                <i class="fa-solid fa-arrow-up-right-from-square" aria-hidden="true"></i>
                View storefront
            </a>
            <button class="button" type="button" id="export-orders">
                <i class="fa-solid fa-file-arrow-down" aria-hidden="true"></i>
                Export CSV
            </button>
            <button class="button button-danger" type="button" id="clear-orders">
                <i class="fa-solid fa-trash-can" aria-hidden="true"></i>
                Clear orders
            </button>
        </div>
    </header>
    <main class="admin-main">
        <section class="metric-grid">
            <article class="metric-card">
                <span class="metric-label">Total orders</span>
                <span class="metric-value" data-metric="orders">0</span>
                <span class="metric-footnote">All time</span>
            </article>
            <article class="metric-card">
                <span class="metric-label">Open queue</span>
                <span class="metric-value" data-metric="open">0</span>
                <span class="metric-footnote">Pending fulfilment</span>
            </article>
            <article class="metric-card">
                <span class="metric-label">Revenue captured</span>
                <span class="metric-value" data-metric="revenue">â¹0.00</span>
                <span class="metric-footnote">Includes all orders</span>
            </article>
            <article class="metric-card">
                <span class="metric-label">Average ticket</span>
                <span class="metric-value" data-metric="average">â¹0.00</span>
                <span class="metric-footnote">Per order</span>
            </article>
            <article class="metric-card">
                <span class="metric-label">Top product</span>
                <span class="metric-value" data-metric="top-seller">â</span>
                <span class="metric-footnote">Most ordered item</span>
            </article>
        </section>

        <section class="control-panel">
            <div class="form-field">
                <label class="field-label" for="admin-search">Search orders</label>
                <input type="search" id="admin-search" placeholder="Search by ID, phone, address or item..." autocomplete="off">
            </div>
            <div class="form-field">
                <span class="field-label">Status filter</span>
                <div class="chip-group">
                    <button type="button" class="chip chip--active" data-status-filter="all">All</button>
                    <button type="button" class="chip" data-status-filter="Pending">Pending</button>
                    <button type="button" class="chip" data-status-filter="Preparing">Preparing</button>
                    <button type="button" class="chip" data-status-filter="Ready">Ready</button>
                    <button type="button" class="chip" data-status-filter="Out for Delivery">Out for Delivery</button>
                    <button type="button" class="chip" data-status-filter="Delivered">Delivered</button>
                </div>
            </div>
            <div class="form-field">
                <label class="field-label" for="date-filter">Placed within</label>
                <select id="date-filter">
                    <option value="all">All dates</option>
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                </select>
            </div>
            <div class="form-field">
                <label class="field-label">High value highlight</label>
                <div class="toggle-field">
                    <input type="checkbox" id="high-value-toggle">
                    <span>Only show orders â¥ â¹1,200</span>
                </div>
            </div>
        </section>

        <section class="orders-section">
            <div class="orders-header">
                <div>
                    <h2>Order queue</h2>
                    <p class="help-text">Incoming orders sync from the storefront checkout in this browser.</p>
                </div>
                <span class="order-count" id="order-count">0 orders</span>
            </div>
            <div class="order-list order-list--empty" id="order-list"></div>
        </section>
    </main>
    <footer class="admin-footer">
        Â© <span id="current-year"></span> Sweet Delights Bakery Â· Internal use only
    </footer>
    <script>
        (function () {
            const STORAGE_KEY = 'orders';
            const ORDER_STATUSES = ['Pending', 'Preparing', 'Ready', 'Out for Delivery', 'Delivered'];
            const HIGH_VALUE_THRESHOLD = 1200;
            const state = {
                search: '',
                highValueOnly: false,
                dateRange: 'all'
            };
            let activeStatus = 'all';
            let orders = normalizeOrders(loadOrders());

            const elements = {
                search: document.getElementById('admin-search'),
                statusButtons: Array.from(document.querySelectorAll('[data-status-filter]')),
                highValueToggle: document.getElementById('high-value-toggle'),
                dateFilter: document.getElementById('date-filter'),
                orderList: document.getElementById('order-list'),
                orderCount: document.getElementById('order-count'),
                totalOrders: document.querySelector('[data-metric="orders"]'),
                openOrders: document.querySelector('[data-metric="open"]'),
                revenueTotal: document.querySelector('[data-metric="revenue"]'),
                averageValue: document.querySelector('[data-metric="average"]'),
                topSeller: document.querySelector('[data-metric="top-seller"]'),
                exportBtn: document.getElementById('export-orders'),
                clearBtn: document.getElementById('clear-orders')
            };

            document.getElementById('current-year').textContent = new Date().getFullYear();

            bindEvents();
            refresh();

            function bindEvents() {
                if (elements.search) {
                    elements.search.addEventListener('input', event => {
                        state.search = event.target.value.trim().toLowerCase();
                        refresh();
                    });
                }

                elements.statusButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        activeStatus = button.dataset.statusFilter;
                        updateStatusButtons();
                        refresh();
                    });
                });

                if (elements.highValueToggle) {
                    elements.highValueToggle.addEventListener('change', event => {
                        state.highValueOnly = event.target.checked;
                        refresh();
                    });
                }

                if (elements.dateFilter) {
                    elements.dateFilter.addEventListener('change', event => {
                        state.dateRange = event.target.value;
                        refresh();
                    });
                }

                if (elements.exportBtn) {
                    elements.exportBtn.addEventListener('click', exportOrders);
                }

                if (elements.clearBtn) {
                    elements.clearBtn.addEventListener('click', clearOrders);
                }

                if (elements.orderList) {
                    elements.orderList.addEventListener('change', event => {
                        if (event.target.matches('.order-status-select')) {
                            updateOrderStatus(event.target.dataset.orderId, event.target.value);
                        }
                    });

                    elements.orderList.addEventListener('input', event => {
                        if (event.target.matches('.order-note-input')) {
                            updateOrderNote(event.target.dataset.orderId, event.target.value);
                        }
                    });

                    elements.orderList.addEventListener('click', event => {
                        if (event.target.matches('.copy-details')) {
                            copyShippingDetails(event.target.dataset.orderId, event.target);
                        }
                    });
                }
            }

            function refresh() {
                const filteredOrders = applyFilters();
                renderMetrics();
                renderOrders(filteredOrders);
                updateOrderCount(filteredOrders.length);
                document.title = `Admin Â· ${orders.length} orders`;
            }

            function loadOrders() {
                try {
                    const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
                    return Array.isArray(stored) ? stored : [];
                } catch (error) {
                    console.warn('Unable to parse saved orders:', error);
                    return [];
                }
            }

            function normalizeOrders(rawOrders) {
                let mutated = false;
                const normalized = rawOrders.map(order => {
                    const current = { ...order };
                    if (!current.status) {
                        current.status = 'Pending';
                        mutated = true;
                    }
                    if (typeof current.note !== 'string') {
                        current.note = '';
                        mutated = true;
                    }
                    return current;
                });
                if (mutated) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
                }
                return normalized;
            }

            function saveOrders() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
            }

            function applyFilters() {
                return orders.filter(order => {
                    const matchesStatus = activeStatus === 'all' || order.status === activeStatus;
                    const matchesHighValue = !state.highValueOnly || Number(order.total || 0) >= HIGH_VALUE_THRESHOLD;
                    const matchesSearch = state.search === '' || [
                        order.id,
                        order.phone,
                        order.address,
                        (order.items || []).map(item => item.name).join(' ')
                    ].some(field => typeof field === 'string' && field.toLowerCase().includes(state.search));
                    const matchesDate = checkDate(order.date);
                    return matchesStatus && matchesHighValue && matchesSearch && matchesDate;
                });
            }

            function checkDate(dateValue) {
                if (state.dateRange === 'all') return true;
                const orderDate = new Date(dateValue);
                if (Number.isNaN(orderDate.getTime())) return false;
                const now = new Date();
                const diff = (now - orderDate) / (1000 * 60 * 60 * 24);
                if (state.dateRange === '7') {
                    return diff <= 7;
                }
                if (state.dateRange === '30') {
                    return diff <= 30;
                }
                return true;
            }

            function renderMetrics() {
                const totalOrders = orders.length;
                const openOrders = orders.filter(order => order.status !== 'Delivered').length;
                const revenue = orders.reduce((sum, order) => sum + Number(order.total || 0), 0);
                const average = totalOrders ? revenue / totalOrders : 0;
                const topProduct = calculateTopSeller() || 'â';

                if (elements.totalOrders) {
                    elements.totalOrders.textContent = totalOrders.toLocaleString('en-IN');
                }
                if (elements.openOrders) {
                    elements.openOrders.textContent = openOrders.toLocaleString('en-IN');
                }
                if (elements.revenueTotal) {
                    elements.revenueTotal.textContent = `â¹${formatCurrency(revenue)}`;
                }
                if (elements.averageValue) {
                    elements.averageValue.textContent = `â¹${formatCurrency(average)}`;
                }
                if (elements.topSeller) {
                    elements.topSeller.textContent = topProduct;
                }
            }

            function calculateTopSeller() {
                const counts = new Map();
                orders.forEach(order => {
                    (order.items || []).forEach(item => {
                        const quantity = Number(item.quantity || 0);
                        counts.set(item.name, (counts.get(item.name) || 0) + quantity);
                    });
                });
                if (!counts.size) {
                    return null;
                }
                return [...counts.entries()].sort((a, b) => b[1] - a[1])[0][0];
            }

            function renderOrders(list) {
                if (!elements.orderList) return;
                if (!list.length) {
                    elements.orderList.classList.add('order-list--empty');
                    elements.orderList.innerHTML = `
                        <div class="empty-state">
                            <i class="fa-solid fa-cookie-bite" aria-hidden="true"></i>
                            <p>No orders match the current filters.</p>
                            <p class="hint">Adjust filters or collect new orders from the storefront.</p>
                        </div>
                    `;
                    return;
                }
                elements.orderList.classList.remove('order-list--empty');
                elements.orderList.innerHTML = list.map(order => createOrderMarkup(order)).join('');
            }

            function createOrderMarkup(order) {
                const items = (order.items || []).map(item => `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>â¹${formatCurrency(item.price)}</td>
                        <td>â¹${formatCurrency((item.price || 0) * (item.quantity || 0))}</td>
                    </tr>
                `).join('');
                return `
                    <article class="order-card" data-status="${order.status}">
                        <header class="order-card__header">
                            <div>
                                <h3>Order ${order.id}</h3>
                                <p class="order-meta">${formatDate(order.date)}</p>
                            </div>
                            <div class="order-status">
                                <span class="status-pill" data-status="${order.status}">${order.status}</span>
                                <span class="status-label">Update status</span>
                                <select class="order-status-select" data-order-id="${order.id}">
                                    ${createStatusOptions(order.status)}
                                </select>
                            </div>
                        </header>
                        <div class="order-card__body">
                            <table class="item-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Line total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items}
                                </tbody>
                            </table>
                            <dl class="order-details">
                                <div>
                                    <dt>Total</dt>
                                    <dd>â¹${formatCurrency(order.total)}</dd>
                                </div>
                                <div>
                                    <dt>Phone</dt>
                                    <dd>${order.phone}</dd>
                                </div>
                                <div>
                                    <dt>Address</dt>
                                    <dd>${order.address}</dd>
                                </div>
                            </dl>
                        </div>
                        <footer class="order-card__footer">
                            <label class="note-label">Admin notes</label>
                            <textarea class="order-note-input" data-order-id="${order.id}" placeholder="Add reminders or follow-up tasks...">${order.note || ''}</textarea>
                            <div class="card-actions">
                                <button type="button" class="ghost-button copy-details" data-order-id="${order.id}">
                                    <i class="fa-regular fa-copy" aria-hidden="true"></i>
                                    Copy shipping details
                                </button>
                            </div>
                        </footer>
                    </article>
                `;
            }

            function createStatusOptions(selected) {
                return ORDER_STATUSES.map(status => `
                    <option value="${status}" ${status === selected ? 'selected' : ''}>${status}</option>
                `).join('');
            }

            function updateOrderStatus(orderId, newStatus) {
                orders = orders.map(order => order.id === orderId ? { ...order, status: newStatus } : order);
                saveOrders();
                refresh();
            }

            function updateOrderNote(orderId, noteValue) {
                orders = orders.map(order => order.id === orderId ? { ...order, note: noteValue } : order);
                saveOrders();
            }

            function copyShippingDetails(orderId, trigger) {
                const order = orders.find(entry => entry.id === orderId);
                if (!order) return;
                const lines = [
                    `Order ${order.id}`,
                    `Phone: ${order.phone}`,
                    `Address: ${order.address}`,
                    `Total: â¹${formatCurrency(order.total)}`
                ];
                const text = lines.join('\n');
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => showCopiedState(trigger)).catch(() => fallbackCopy(text, trigger));
                } else {
                    fallbackCopy(text, trigger);
                }
            }

            function fallbackCopy(text, trigger) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showCopiedState(trigger);
                } catch (error) {
                    alert('Copy not supported in this browser. Please copy manually.');
                } finally {
                    document.body.removeChild(textarea);
                }
            }

            function showCopiedState(button) {
                if (!button) return;
                const original = button.innerHTML;
                button.classList.add('ghost-button--success');
                button.innerHTML = '<i class="fa-solid fa-check" aria-hidden="true"></i> Copied!';
                setTimeout(() => {
                    button.classList.remove('ghost-button--success');
                    button.innerHTML = original;
                }, 1300);
            }

            function exportOrders() {
                if (!orders.length) {
                    alert('No orders available to export yet.');
                    return;
                }
                const header = ['Order ID', 'Date', 'Status', 'Phone', 'Address', 'Item', 'Quantity', 'Price', 'Line Total'];
                const rows = orders.flatMap(order => {
                    return (order.items || []).map(item => [
                        wrapCsv(order.id),
                        wrapCsv(formatDate(order.date)),
                        wrapCsv(order.status),
                        wrapCsv(order.phone),
                        wrapCsv(order.address),
                        wrapCsv(item.name),
                        wrapCsv(item.quantity),
                        wrapCsv(formatCurrency(item.price)),
                        wrapCsv(formatCurrency((item.price || 0) * (item.quantity || 0)))
                    ].join(','));
                });
                const csv = [header.join(','), ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `sweet-delights-orders-${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            function wrapCsv(value) {
                if (value === undefined || value === null) return '""';
                const stringValue = String(value).replace(/"/g, '""');
                return `"${stringValue}"`;
            }

            function clearOrders() {
                if (!orders.length) {
                    alert('There are no orders stored in this browser.');
                    return;
                }
                const confirmed = confirm('This will remove all saved orders from this browser. Continue?');
                if (!confirmed) return;
                orders = [];
                saveOrders();
                refresh();
            }

            function updateOrderCount(count) {
                if (elements.orderCount) {
                    elements.orderCount.textContent = `${count} ${count === 1 ? 'order' : 'orders'}`;
                }
            }

            function formatDate(value) {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return 'Unknown date';
                return date.toLocaleString('en-IN', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function formatCurrency(value) {
                const number = Number(value || 0);
                return number.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function updateStatusButtons() {
                elements.statusButtons.forEach(button => {
                    if (button.dataset.statusFilter === activeStatus) {
                        button.classList.add('chip--active');
                    } else {
                        button.classList.remove('chip--active');
                    }
                });
            }
        })();
    </script>
</body>
</html>