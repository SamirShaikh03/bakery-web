<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/Sweet_Delight_icon.png" type="image/png">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" 
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Sweet Delights · Admin Dashboard</title>
</head>
<body>
    <!-- ========== Admin Header ========== -->
    <header class="admin-header">
        <a class="brand" href="index.html">
            <img src="assets/Sweet_Delight_icon.png" alt="Sweet Delights logo">
            <span>
                Sweet Delights
                <small>Admin Dashboard</small>
            </span>
        </a>
        <div class="header-actions">
            <a class="button-secondary button" href="index.html" target="_blank" rel="noopener">
                <i class="fa-solid fa-arrow-up-right-from-square" aria-hidden="true"></i>
                View Storefront
            </a>
            <button class="button" type="button" id="refresh-data">
                <i class="fa-solid fa-arrows-rotate" aria-hidden="true"></i>
                Refresh
            </button>
            <button class="button" type="button" id="export-orders">
                <i class="fa-solid fa-file-arrow-down" aria-hidden="true"></i>
                Export CSV
            </button>
            <button class="button button-danger" type="button" id="clear-orders">
                <i class="fa-solid fa-trash-can" aria-hidden="true"></i>
                Clear Orders
            </button>
        </div>
    </header>

    <!-- ========== Main Content ========== -->
    <main class="admin-main">
        
        <!-- ========== Key Metrics Dashboard ========== -->
        <section class="metric-grid fade-in">
            <article class="metric-card">
                <div class="metric-header">
                    <div>
                        <span class="metric-label">Total Orders</span>
                        <span class="metric-value" data-metric="orders">0</span>
                    </div>
                    <div class="metric-icon metric-icon--primary">
                        <i class="fa-solid fa-cart-shopping"></i>
                    </div>
                </div>
                <span class="metric-change metric-change--neutral" data-metric="orders-change">
                    <i class="fa-solid fa-minus"></i> No change
                </span>
                <span class="metric-footnote">All time orders</span>
            </article>

            <article class="metric-card">
                <div class="metric-header">
                    <div>
                        <span class="metric-label">Open Queue</span>
                        <span class="metric-value" data-metric="open">0</span>
                    </div>
                    <div class="metric-icon metric-icon--warning">
                        <i class="fa-solid fa-clock"></i>
                    </div>
                </div>
                <span class="metric-change metric-change--neutral" data-metric="open-change">
                    <i class="fa-solid fa-minus"></i> No change
                </span>
                <span class="metric-footnote">Pending fulfillment</span>
            </article>

            <article class="metric-card">
                <div class="metric-header">
                    <div>
                        <span class="metric-label">Revenue</span>
                        <span class="metric-value" data-metric="revenue">₹0.00</span>
                    </div>
                    <div class="metric-icon metric-icon--success">
                        <i class="fa-solid fa-indian-rupee-sign"></i>
                    </div>
                </div>
                <span class="metric-change metric-change--positive" data-metric="revenue-change">
                    <i class="fa-solid fa-arrow-up"></i> +0%
                </span>
                <span class="metric-footnote">Total captured</span>
            </article>

            <article class="metric-card">
                <div class="metric-header">
                    <div>
                        <span class="metric-label">Average Order</span>
                        <span class="metric-value" data-metric="average">₹0.00</span>
                    </div>
                    <div class="metric-icon metric-icon--info">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                </div>
                <span class="metric-change metric-change--neutral" data-metric="average-change">
                    <i class="fa-solid fa-minus"></i> No change
                </span>
                <span class="metric-footnote">Per order value</span>
            </article>

            <article class="metric-card">
                <div class="metric-header">
                    <div>
                        <span class="metric-label">Top Seller</span>
                        <span class="metric-value" data-metric="top-seller" style="font-size: 1.2rem;">—</span>
                    </div>
                    <div class="metric-icon metric-icon--primary">
                        <i class="fa-solid fa-trophy"></i>
                    </div>
                </div>
                <span class="metric-footnote">Most ordered item</span>
            </article>

            <article class="metric-card">
                <div class="metric-header">
                    <div>
                        <span class="metric-label">Today's Orders</span>
                        <span class="metric-value" data-metric="today">0</span>
                    </div>
                    <div class="metric-icon metric-icon--success">
                        <i class="fa-solid fa-calendar-day"></i>
                    </div>
                </div>
                <span class="metric-change metric-change--positive" data-metric="today-change">
                    <i class="fa-solid fa-arrow-up"></i> Active
                </span>
                <span class="metric-footnote">Received today</span>
            </article>
        </section>

        <!-- ========== Sales Analytics Chart ========== -->
        <section class="analytics-section fade-in">
            <div class="section-header">
                <h2>
                    <i class="fa-solid fa-chart-column"></i>
                    Sales Analytics
                    <span class="section-badge">Live</span>
                </h2>
                <div class="section-actions">
                    <select id="chart-period" class="button">
                        <option value="7">Last 7 Days</option>
                        <option value="14">Last 14 Days</option>
                        <option value="30">Last 30 Days</option>
                    </select>
                </div>
            </div>
            <div class="chart-container" id="sales-chart">
                <div class="chart-placeholder">
                    <i class="fa-solid fa-chart-simple"></i>
                    <p>Sales data will appear here</p>
                </div>
            </div>
        </section>

        <!-- ========== Statistics Grid ========== -->
        <section class="analytics-section fade-in">
            <div class="section-header">
                <h2>
                    <i class="fa-solid fa-table-cells"></i>
                    Quick Statistics
                </h2>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Delivered Orders</span>
                    <span class="stat-value" data-metric="delivered">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">In Progress</span>
                    <span class="stat-value" data-metric="in-progress">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total Products Sold</span>
                    <span class="stat-value" data-metric="products-sold">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg. Fulfillment Time</span>
                    <span class="stat-value" data-metric="fulfillment-time">—</span>
                </div>
            </div>
        </section>

        <!-- ========== Quick Actions ========== -->
        <section class="quick-actions fade-in">
            <div class="section-header">
                <h2>
                    <i class="fa-solid fa-bolt"></i>
                    Quick Actions
                </h2>
            </div>
            <div class="action-grid">
                <div class="action-card" onclick="document.getElementById('admin-search').focus()">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span class="action-title">Search Orders</span>
                </div>
                <div class="action-card" onclick="filterByStatus('Pending')">
                    <i class="fa-solid fa-filter"></i>
                    <span class="action-title">View Pending</span>
                </div>
                <div class="action-card" onclick="document.getElementById('export-orders').click()">
                    <i class="fa-solid fa-download"></i>
                    <span class="action-title">Export Data</span>
                </div>
                <div class="action-card" onclick="document.getElementById('refresh-data').click()">
                    <i class="fa-solid fa-sync"></i>
                    <span class="action-title">Refresh Data</span>
                </div>
            </div>
        </section>

        <!-- ========== Control Panel & Filters ========== -->
        <section class="control-panel fade-in">
            <div class="form-field">
                <label class="field-label" for="admin-search">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    Search Orders
                </label>
                <input type="search" id="admin-search" placeholder="Search by ID, phone, address or item..." autocomplete="off">
            </div>
            
            <div class="form-field">
                <span class="field-label">
                    <i class="fa-solid fa-filter"></i>
                    Status Filter
                </span>
                <div class="chip-group">
                    <button type="button" class="chip chip--active" data-status-filter="all">All</button>
                    <button type="button" class="chip" data-status-filter="Pending">Pending</button>
                    <button type="button" class="chip" data-status-filter="Preparing">Preparing</button>
                    <button type="button" class="chip" data-status-filter="Ready">Ready</button>
                    <button type="button" class="chip" data-status-filter="Out for Delivery">Delivering</button>
                    <button type="button" class="chip" data-status-filter="Delivered">Delivered</button>
                </div>
            </div>
            
            <div class="form-field">
                <label class="field-label" for="date-filter">
                    <i class="fa-solid fa-calendar"></i>
                    Date Range
                </label>
                <select id="date-filter">
                    <option value="all">All Dates</option>
                    <option value="today">Today</option>
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
            
            <div class="form-field">
                <label class="field-label">
                    <i class="fa-solid fa-star"></i>
                    High Value Orders
                </label>
                <div class="toggle-field">
                    <input type="checkbox" id="high-value-toggle">
                    <span>Show orders ≥ ₹1,200</span>
                </div>
            </div>
        </section>

        <!-- ========== Orders Section ========== -->
        <section class="orders-section fade-in">
            <div class="orders-header">
                <div>
                    <h2>Order Queue</h2>
                    <p class="help-text">Incoming orders sync from the storefront checkout in real-time.</p>
                </div>
                <span class="order-count" id="order-count">0 orders</span>
            </div>
            <div class="order-list order-list--empty" id="order-list">
                <div class="empty-state">
                    <i class="fa-solid fa-cookie-bite" aria-hidden="true"></i>
                    <p>No orders to display</p>
                    <p class="hint">Orders will appear here when customers place them from the storefront.</p>
                </div>
            </div>
        </section>

        <!-- ========== Recent Activity Feed ========== -->
        <section class="activity-feed fade-in">
            <div class="section-header">
                <h2>
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    Recent Activity
                </h2>
            </div>
            <div class="activity-list" id="activity-list">
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fa-solid fa-info"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">Admin dashboard initialized</div>
                        <div class="activity-time">Just now</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ========== Footer ========== -->
    <footer class="admin-footer">
        © <span id="current-year"></span> Sweet Delights Bakery · Admin Dashboard ·
        <a href="index.html">Back to Store</a>
    </footer>

    <!-- ========== JavaScript ========== -->
    <script>
        (function () {
            'use strict';

            // ========== Configuration ==========
            const STORAGE_KEY = 'orders';
            const ORDER_STATUSES = ['Pending', 'Preparing', 'Ready', 'Out for Delivery', 'Delivered'];
            const HIGH_VALUE_THRESHOLD = 1200;
            
            // ========== State Management ==========
            const state = {
                search: '',
                highValueOnly: false,
                dateRange: 'all',
                lastMetrics: {}
            };
            
            let activeStatus = 'all';
            let orders = normalizeOrders(loadOrders());
            let activityLog = [];

            // ========== DOM Elements ==========
            const elements = {
                search: document.getElementById('admin-search'),
                statusButtons: Array.from(document.querySelectorAll('[data-status-filter]')),
                highValueToggle: document.getElementById('high-value-toggle'),
                dateFilter: document.getElementById('date-filter'),
                orderList: document.getElementById('order-list'),
                orderCount: document.getElementById('order-count'),
                refreshBtn: document.getElementById('refresh-data'),
                exportBtn: document.getElementById('export-orders'),
                clearBtn: document.getElementById('clear-orders'),
                activityList: document.getElementById('activity-list'),
                chartPeriod: document.getElementById('chart-period'),
                salesChart: document.getElementById('sales-chart'),
                // Metrics
                totalOrders: document.querySelector('[data-metric="orders"]'),
                openOrders: document.querySelector('[data-metric="open"]'),
                revenueTotal: document.querySelector('[data-metric="revenue"]'),
                averageValue: document.querySelector('[data-metric="average"]'),
                topSeller: document.querySelector('[data-metric="top-seller"]'),
                todayOrders: document.querySelector('[data-metric="today"]'),
                deliveredOrders: document.querySelector('[data-metric="delivered"]'),
                inProgressOrders: document.querySelector('[data-metric="in-progress"]'),
                productsSold: document.querySelector('[data-metric="products-sold"]'),
                fulfillmentTime: document.querySelector('[data-metric="fulfillment-time"]')
            };

            // ========== Initialization ==========
            document.getElementById('current-year').textContent = new Date().getFullYear();
            bindEvents();
            refresh();
            initializeCharts();
            logActivity('Admin dashboard loaded', 'info');

            // ========== Event Bindings ==========
            function bindEvents() {
                if (elements.search) {
                    elements.search.addEventListener('input', event => {
                        state.search = event.target.value.trim().toLowerCase();
                        refresh();
                    });
                }

                elements.statusButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        activeStatus = button.dataset.statusFilter;
                        updateStatusButtons();
                        refresh();
                        logActivity(`Filtered by status: ${activeStatus}`, 'filter');
                    });
                });

                if (elements.highValueToggle) {
                    elements.highValueToggle.addEventListener('change', event => {
                        state.highValueOnly = event.target.checked;
                        refresh();
                        logActivity(`High value filter: ${event.target.checked ? 'ON' : 'OFF'}`, 'filter');
                    });
                }

                if (elements.dateFilter) {
                    elements.dateFilter.addEventListener('change', event => {
                        state.dateRange = event.target.value;
                        refresh();
                        logActivity(`Date range changed: ${event.target.value}`, 'filter');
                    });
                }

                if (elements.refreshBtn) {
                    elements.refreshBtn.addEventListener('click', () => {
                        orders = normalizeOrders(loadOrders());
                        refresh();
                        logActivity('Data refreshed', 'info');
                        showNotification('Data refreshed successfully!');
                    });
                }

                if (elements.exportBtn) {
                    elements.exportBtn.addEventListener('click', exportOrders);
                }

                if (elements.clearBtn) {
                    elements.clearBtn.addEventListener('click', clearOrders);
                }

                if (elements.chartPeriod) {
                    elements.chartPeriod.addEventListener('change', () => {
                        updateSalesChart();
                    });
                }

                if (elements.orderList) {
                    elements.orderList.addEventListener('change', event => {
                        if (event.target.matches('.order-status-select')) {
                            const oldStatus = event.target.dataset.oldStatus;
                            const newStatus = event.target.value;
                            updateOrderStatus(event.target.dataset.orderId, newStatus);
                            logActivity(`Order ${event.target.dataset.orderId} status: ${oldStatus} → ${newStatus}`, 'update');
                        }
                    });

                    elements.orderList.addEventListener('input', event => {
                        if (event.target.matches('.order-note-input')) {
                            updateOrderNote(event.target.dataset.orderId, event.target.value);
                        }
                    });

                    elements.orderList.addEventListener('click', event => {
                        if (event.target.matches('.copy-details') || event.target.closest('.copy-details')) {
                            const button = event.target.matches('.copy-details') ? event.target : event.target.closest('.copy-details');
                            copyShippingDetails(button.dataset.orderId, button);
                        }
                    });
                }

                // Listen for storage changes (orders from storefront)
                window.addEventListener('storage', event => {
                    if (event.key === STORAGE_KEY) {
                        orders = normalizeOrders(loadOrders());
                        refresh();
                        logActivity('New order received from storefront', 'success');
                    }
                });
            }

            // ========== Main Refresh Function ==========
            function refresh() {
                const filteredOrders = applyFilters();
                renderMetrics();
                renderOrders(filteredOrders);
                updateOrderCount(filteredOrders.length);
                updateSalesChart();
                document.title = `Admin · ${orders.length} orders`;
            }

            // ========== Data Loading ==========
            function loadOrders() {
                try {
                    const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
                    return Array.isArray(stored) ? stored : [];
                } catch (error) {
                    console.warn('Unable to parse saved orders:', error);
                    return [];
                }
            }

            function normalizeOrders(rawOrders) {
                let mutated = false;
                const normalized = rawOrders.map(order => {
                    const current = { ...order };
                    if (!current.status) {
                        current.status = 'Pending';
                        mutated = true;
                    }
                    if (typeof current.note !== 'string') {
                        current.note = '';
                        mutated = true;
                    }
                    if (!current.date) {
                        current.date = new Date().toISOString();
                        mutated = true;
                    }
                    return current;
                });
                if (mutated) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(normalized));
                }
                return normalized;
            }

            function saveOrders() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
            }

            // ========== Filtering ==========
            function applyFilters() {
                return orders.filter(order => {
                    const matchesStatus = activeStatus === 'all' || order.status === activeStatus;
                    const matchesHighValue = !state.highValueOnly || Number(order.total || 0) >= HIGH_VALUE_THRESHOLD;
                    const matchesSearch = state.search === '' || [
                        order.id,
                        order.phone,
                        order.address,
                        (order.items || []).map(item => item.name).join(' ')
                    ].some(field => typeof field === 'string' && field.toLowerCase().includes(state.search));
                    const matchesDate = checkDate(order.date);
                    return matchesStatus && matchesHighValue && matchesSearch && matchesDate;
                });
            }

            function checkDate(dateValue) {
                if (state.dateRange === 'all') return true;
                const orderDate = new Date(dateValue);
                if (Number.isNaN(orderDate.getTime())) return false;
                const now = new Date();
                const diff = (now - orderDate) / (1000 * 60 * 60 * 24);
                
                if (state.dateRange === 'today') {
                    return orderDate.toDateString() === now.toDateString();
                }
                if (state.dateRange === '7') {
                    return diff <= 7;
                }
                if (state.dateRange === '30') {
                    return diff <= 30;
                }
                if (state.dateRange === '90') {
                    return diff <= 90;
                }
                return true;
            }

            // ========== Metrics Rendering ==========
            function renderMetrics() {
                const totalOrders = orders.length;
                const openOrders = orders.filter(order => order.status !== 'Delivered').length;
                const deliveredOrders = orders.filter(order => order.status === 'Delivered').length;
                const inProgressOrders = orders.filter(order => 
                    order.status === 'Preparing' || order.status === 'Ready' || order.status === 'Out for Delivery'
                ).length;
                const revenue = orders.reduce((sum, order) => sum + Number(order.total || 0), 0);
                const average = totalOrders ? revenue / totalOrders : 0;
                const topProduct = calculateTopSeller() || '—';
                const todayOrders = orders.filter(order => {
                    const orderDate = new Date(order.date);
                    const today = new Date();
                    return orderDate.toDateString() === today.toDateString();
                }).length;
                const productsSold = orders.reduce((sum, order) => {
                    return sum + (order.items || []).reduce((itemSum, item) => itemSum + Number(item.quantity || 0), 0);
                }, 0);

                // Update metrics
                if (elements.totalOrders) elements.totalOrders.textContent = totalOrders.toLocaleString('en-IN');
                if (elements.openOrders) elements.openOrders.textContent = openOrders.toLocaleString('en-IN');
                if (elements.revenueTotal) elements.revenueTotal.textContent = `₹${formatCurrency(revenue)}`;
                if (elements.averageValue) elements.averageValue.textContent = `₹${formatCurrency(average)}`;
                if (elements.topSeller) elements.topSeller.textContent = topProduct;
                if (elements.todayOrders) elements.todayOrders.textContent = todayOrders.toLocaleString('en-IN');
                if (elements.deliveredOrders) elements.deliveredOrders.textContent = deliveredOrders.toLocaleString('en-IN');
                if (elements.inProgressOrders) elements.inProgressOrders.textContent = inProgressOrders.toLocaleString('en-IN');
                if (elements.productsSold) elements.productsSold.textContent = productsSold.toLocaleString('en-IN');
                
                // Calculate fulfillment time (mock for now)
                if (elements.fulfillmentTime) {
                    elements.fulfillmentTime.textContent = deliveredOrders > 0 ? '2.5 hrs' : '—';
                }

                // Update change indicators
                updateMetricChanges({
                    orders: totalOrders,
                    open: openOrders,
                    revenue: revenue,
                    average: average,
                    today: todayOrders
                });
            }

            function updateMetricChanges(currentMetrics) {
                const changes = {
                    orders: calculateChange(state.lastMetrics.orders, currentMetrics.orders),
                    open: calculateChange(state.lastMetrics.open, currentMetrics.open),
                    revenue: calculateChange(state.lastMetrics.revenue, currentMetrics.revenue),
                    average: calculateChange(state.lastMetrics.average, currentMetrics.average),
                    today: calculateChange(state.lastMetrics.today, currentMetrics.today)
                };

                // Update change displays
                Object.keys(changes).forEach(key => {
                    const element = document.querySelector(`[data-metric="${key}-change"]`);
                    if (element && changes[key] !== null) {
                        const change = changes[key];
                        if (change > 0) {
                            element.className = 'metric-change metric-change--positive';
                            element.innerHTML = `<i class="fa-solid fa-arrow-up"></i> +${change}%`;
                        } else if (change < 0) {
                            element.className = 'metric-change metric-change--negative';
                            element.innerHTML = `<i class="fa-solid fa-arrow-down"></i> ${change}%`;
                        } else {
                            element.className = 'metric-change metric-change--neutral';
                            element.innerHTML = `<i class="fa-solid fa-minus"></i> No change`;
                        }
                    }
                });

                state.lastMetrics = currentMetrics;
            }

            function calculateChange(oldValue, newValue) {
                if (oldValue === undefined || oldValue === null || oldValue === 0) return null;
                return Math.round(((newValue - oldValue) / oldValue) * 100);
            }

            function calculateTopSeller() {
                const counts = new Map();
                orders.forEach(order => {
                    (order.items || []).forEach(item => {
                        const quantity = Number(item.quantity || 0);
                        counts.set(item.name, (counts.get(item.name) || 0) + quantity);
                    });
                });
                if (!counts.size) return null;
                return [...counts.entries()].sort((a, b) => b[1] - a[1])[0][0];
            }

            // ========== Orders Rendering ==========
            function renderOrders(list) {
                if (!elements.orderList) return;
                if (!list.length) {
                    elements.orderList.classList.add('order-list--empty');
                    elements.orderList.innerHTML = `
                        <div class="empty-state">
                            <i class="fa-solid fa-cookie-bite" aria-hidden="true"></i>
                            <p>No orders match the current filters</p>
                            <p class="hint">Adjust filters or collect new orders from the storefront.</p>
                        </div>
                    `;
                    return;
                }
                elements.orderList.classList.remove('order-list--empty');
                elements.orderList.innerHTML = list.map(order => createOrderMarkup(order)).join('');
            }

            function createOrderMarkup(order) {
                const items = (order.items || []).map(item => `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td>${item.quantity}</td>
                        <td>₹${formatCurrency(item.price)}</td>
                        <td><strong>₹${formatCurrency((item.price || 0) * (item.quantity || 0))}</strong></td>
                    </tr>
                `).join('');

                return `
                    <article class="order-card fade-in" data-status="${order.status}">
                        <header class="order-card__header">
                            <div>
                                <h3>Order #${order.id}</h3>
                                <p class="order-meta">
                                    <i class="fa-solid fa-clock"></i>
                                    ${formatDate(order.date)}
                                </p>
                            </div>
                            <div class="order-status">
                                <span class="status-pill" data-status="${order.status}">${order.status}</span>
                                <span class="status-label">Update Status</span>
                                <select class="order-status-select" data-order-id="${order.id}" data-old-status="${order.status}">
                                    ${createStatusOptions(order.status)}
                                </select>
                            </div>
                        </header>
                        <div class="order-card__body">
                            <table class="item-table">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Qty</th>
                                        <th>Price</th>
                                        <th>Line Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items}
                                </tbody>
                            </table>
                            <dl class="order-details">
                                <div>
                                    <dt>Order Total</dt>
                                    <dd><strong>₹${formatCurrency(order.total)}</strong></dd>
                                </div>
                                <div>
                                    <dt>Customer Phone</dt>
                                    <dd>${order.phone}</dd>
                                </div>
                                <div>
                                    <dt>Delivery Address</dt>
                                    <dd>${order.address}</dd>
                                </div>
                            </dl>
                        </div>
                        <footer class="order-card__footer">
                            <label class="note-label">
                                <i class="fa-solid fa-note-sticky"></i>
                                Admin Notes
                            </label>
                            <textarea class="order-note-input" data-order-id="${order.id}" placeholder="Add reminders, special instructions, or follow-up tasks...">${order.note || ''}</textarea>
                            <div class="card-actions">
                                <button type="button" class="ghost-button copy-details" data-order-id="${order.id}">
                                    <i class="fa-regular fa-copy" aria-hidden="true"></i>
                                    Copy Shipping Details
                                </button>
                                <button type="button" class="ghost-button" onclick="window.print()">
                                    <i class="fa-solid fa-print" aria-hidden="true"></i>
                                    Print Order
                                </button>
                            </div>
                        </footer>
                    </article>
                `;
            }

            function createStatusOptions(selected) {
                return ORDER_STATUSES.map(status => `
                    <option value="${status}" ${status === selected ? 'selected' : ''}>${status}</option>
                `).join('');
            }

            // ========== Order Actions ==========
            function updateOrderStatus(orderId, newStatus) {
                orders = orders.map(order => order.id === orderId ? { ...order, status: newStatus } : order);
                saveOrders();
                refresh();
            }

            function updateOrderNote(orderId, noteValue) {
                orders = orders.map(order => order.id === orderId ? { ...order, note: noteValue } : order);
                saveOrders();
            }

            function copyShippingDetails(orderId, trigger) {
                const order = orders.find(entry => entry.id === orderId);
                if (!order) return;
                const lines = [
                    `Order #${order.id}`,
                    `Phone: ${order.phone}`,
                    `Address: ${order.address}`,
                    `Total: ₹${formatCurrency(order.total)}`,
                    `Status: ${order.status}`
                ];
                const text = lines.join('\n');
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        showCopiedState(trigger);
                        logActivity(`Copied details for Order #${orderId}`, 'action');
                    }).catch(() => fallbackCopy(text, trigger));
                } else {
                    fallbackCopy(text, trigger);
                }
            }

            function fallbackCopy(text, trigger) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showCopiedState(trigger);
                } catch (error) {
                    alert('Copy not supported in this browser. Please copy manually.');
                } finally {
                    document.body.removeChild(textarea);
                }
            }

            function showCopiedState(button) {
                if (!button) return;
                const original = button.innerHTML;
                button.classList.add('ghost-button--success');
                button.innerHTML = '<i class="fa-solid fa-check" aria-hidden="true"></i> Copied!';
                setTimeout(() => {
                    button.classList.remove('ghost-button--success');
                    button.innerHTML = original;
                }, 1500);
            }

            // ========== Export & Clear ==========
            function exportOrders() {
                if (!orders.length) {
                    alert('No orders available to export yet.');
                    return;
                }
                const header = ['Order ID', 'Date', 'Status', 'Phone', 'Address', 'Item', 'Quantity', 'Price', 'Line Total', 'Order Total', 'Notes'];
                const rows = orders.flatMap(order => {
                    return (order.items || []).map((item, index) => [
                        wrapCsv(order.id),
                        wrapCsv(formatDate(order.date)),
                        wrapCsv(order.status),
                        wrapCsv(order.phone),
                        wrapCsv(order.address),
                        wrapCsv(item.name),
                        wrapCsv(item.quantity),
                        wrapCsv(formatCurrency(item.price)),
                        wrapCsv(formatCurrency((item.price || 0) * (item.quantity || 0))),
                        index === 0 ? wrapCsv(formatCurrency(order.total)) : '""',
                        index === 0 ? wrapCsv(order.note || '') : '""'
                    ].join(','));
                });
                const csv = [header.join(','), ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `sweet-delights-orders-${new Date().toISOString().slice(0, 10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                logActivity(`Exported ${orders.length} orders to CSV`, 'success');
                showNotification('Orders exported successfully!');
            }

            function wrapCsv(value) {
                if (value === undefined || value === null) return '""';
                const stringValue = String(value).replace(/"/g, '""');
                return `"${stringValue}"`;
            }

            function clearOrders() {
                if (!orders.length) {
                    alert('There are no orders stored in this browser.');
                    return;
                }
                const confirmed = confirm(`This will permanently remove all ${orders.length} saved orders from this browser. This action cannot be undone. Continue?`);
                if (!confirmed) return;
                orders = [];
                saveOrders();
                refresh();
                logActivity('All orders cleared', 'warning');
                showNotification('All orders have been cleared.');
            }

            // ========== UI Updates ==========
            function updateOrderCount(count) {
                if (elements.orderCount) {
                    elements.orderCount.textContent = `${count} ${count === 1 ? 'order' : 'orders'}`;
                }
            }

            function updateStatusButtons() {
                elements.statusButtons.forEach(button => {
                    if (button.dataset.statusFilter === activeStatus) {
                        button.classList.add('chip--active');
                    } else {
                        button.classList.remove('chip--active');
                    }
                });
            }

            // ========== Charts ==========
            function initializeCharts() {
                updateSalesChart();
            }

            function updateSalesChart() {
                if (!elements.salesChart) return;
                
                const period = parseInt(elements.chartPeriod?.value || '7');
                const salesData = generateSalesData(period);
                
                if (salesData.every(d => d.value === 0)) {
                    elements.salesChart.innerHTML = `
                        <div class="chart-placeholder">
                            <i class="fa-solid fa-chart-simple"></i>
                            <p>No sales data available yet</p>
                        </div>
                    `;
                    return;
                }

                const maxValue = Math.max(...salesData.map(d => d.value), 1);
                const barsHtml = salesData.map(data => {
                    const height = (data.value / maxValue) * 100;
                    return `
                        <div class="bar-chart-item">
                            <div class="bar" style="height: ${height}%">
                                <span class="bar-value">₹${formatCurrency(data.value)}</span>
                            </div>
                            <span class="bar-label">${data.label}</span>
                        </div>
                    `;
                }).join('');

                elements.salesChart.innerHTML = `<div class="bar-chart">${barsHtml}</div>`;
            }

            function generateSalesData(days) {
                const data = [];
                const now = new Date();
                
                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    
                    const dayOrders = orders.filter(order => {
                        const orderDate = new Date(order.date);
                        return orderDate.toDateString() === dateStr;
                    });
                    
                    const dayRevenue = dayOrders.reduce((sum, order) => sum + Number(order.total || 0), 0);
                    
                    data.push({
                        label: date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }),
                        value: dayRevenue
                    });
                }
                
                return data;
            }

            // ========== Activity Log ==========
            function logActivity(message, type = 'info') {
                const activity = {
                    message,
                    type,
                    time: new Date()
                };
                activityLog.unshift(activity);
                activityLog = activityLog.slice(0, 10); // Keep last 10
                renderActivityLog();
            }

            function renderActivityLog() {
                if (!elements.activityList) return;
                
                const icons = {
                    info: 'fa-info-circle',
                    success: 'fa-check-circle',
                    warning: 'fa-exclamation-triangle',
                    error: 'fa-times-circle',
                    filter: 'fa-filter',
                    update: 'fa-sync',
                    action: 'fa-bolt'
                };

                elements.activityList.innerHTML = activityLog.map(activity => `
                    <div class="activity-item slide-in">
                        <div class="activity-icon">
                            <i class="fa-solid ${icons[activity.type] || icons.info}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.message}</div>
                            <div class="activity-time">${formatTimeAgo(activity.time)}</div>
                        </div>
                    </div>
                `).join('');
            }

            // ========== Utilities ==========
            function formatDate(value) {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) return 'Unknown date';
                return date.toLocaleString('en-IN', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                if (seconds < 60) return 'Just now';
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                const days = Math.floor(hours / 24);
                return `${days} day${days > 1 ? 's' : ''} ago`;
            }

            function formatCurrency(value) {
                const number = Number(value || 0);
                return number.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function showNotification(message) {
                // Simple notification - can be enhanced with a toast library
                console.log('Notification:', message);
            }

            // ========== Quick Action Helper ==========
            window.filterByStatus = function(status) {
                activeStatus = status;
                updateStatusButtons();
                refresh();
                logActivity(`Quick filter applied: ${status}`, 'filter');
            };

            // ========== Auto Refresh ==========
            setInterval(() => {
                const newOrders = normalizeOrders(loadOrders());
                if (newOrders.length !== orders.length) {
                    orders = newOrders;
                    refresh();
                    logActivity('New order detected - auto-refreshed', 'success');
                }
            }, 5000); // Check every 5 seconds

        })();
    </script>
</body>
</html>
